var g={timeout:{user:null,users:null,game:null,games:null},status:{},currentRoundID:0,inLobby:true,game:null,human:null,cardsDealt:false,roundLoading:0,waiting:false,userOrder:[],userPosition:0};$(document).ready(function(){$("#reset a").click(function(){g.waiting=false;g.roundLoading=0;doLog("Reset counter to "+g.roundLoading);return false});setActiveUser();g.timeout.user=setInterval("setActiveUser();",60000);getUsers();g.timeout.users=setInterval("getUsers();",5000);getGames();g.timeout.games=setInterval("getGames();",5000)});function setActiveUser(){if(g.inLobby){getJSON({op:"setActiveUser"},function(a){})}}function getUsers(){if(g.inLobby){getJSON({op:"getUsers"},function(d){users=d.users;if(users!={}&&users!=[]){var c="";for(var b in users){var a=users[b];if(a.isActive){c+='<div class="row">';c+='<div class="player-'+b+'"></div>';c+="<span>"+a.name+"<br />";c+="Games: "+a.games+"<br />";c+="Wins: "+a.wins+"</span></div>"}}$("#playersOnline").html(c)}})}}function getGames(){if(g.inLobby){getJSON({op:"getGames"},function(d){if(d.has_data&&d.numGames>0){games=d.games;var c="";c+="<table>";c+="<thead>";c+="<tr>";c+="<th>Game</th>";c+="<th>Seats</th>";c+="<th>Players</th>";c+="<th>Status</th>";c+="</tr>";c+="</thead>";c+="<tbody>";for(var b in games){var e=games[b];if(user.currentGameID==e.id){if(e.status=="Play"){g.inLobby=false;clearInterval(g.timeout.user);clearInterval(g.timeout.users);clearInterval(g.timeout.games);$("#lobby-page, .lobby").hide();$("#nav").addClass("play");$("#play-page, #nav ul, .play").fadeIn();getJSON({op:"getRound",gameID:user.currentGameID},function(f){g.status=f;loadGameBoard();updateStats();g.timeout.game=setInterval("getRound();",1500);if(g.game.cardsDealt){g.waiting=true;setTimeout("g.waiting = false;",5000)}else{getRound()}})}}c+='<tr id="game-'+e.id+'" class="game">';c+="<td>GAME #"+e.id+"</td>";c+="<td>"+e.players+"</td>";c+='<td class="gamesRow">';var a=e.users.split(",");for(var b=0;b<a.length;b++){c+='<span class="player-'+a[b]+'"></span>'}c+="</td>";if(e.status=="Wait"){if(e.ownerID==userID){getJSON({op:"setActiveGame",gameID:user.currentGameID},function(){});if(e.numPlayers==e.players){c+='<td><button id="start-game">Start game</button></td>'}else{c+='<td><button id="delete-game">Delete game</button></td>'}}else{if(e.numPlayers<e.players){if(e.id!=user.currentGameID){c+='<td><button id="join-game">Join game</button></td>'}else{c+='<td><button id="leave-game">Leave game</button></td>'}}else{if(e.id!=user.currentGameID){c+="<td>Game Full</td>"}else{c+="<td>Waiting</td>"}}}}else{if(e.status=="Play"){c+="<td>In Progress</td>"}}c+="</tr>"}c+="</tbody>";c+="</table>";$("#activeGames").html(c);$("#join-game").click(function(){var f=$(this).parent().parent().attr("id").substr(5);if(confirm("You are about to join game #"+f+". Are you sure?")){getJSON({op:"joinGame",gameID:f},function(h){document.location.reload()})}});$("#leave-game").click(function(){var f=$(this).parent().parent().attr("id").substr(5);leaveGameConfirm(f)});$("#delete-game").click(function(){var f=$(this).parent().parent().attr("id").substr(5);if(confirm("This will erase all game data. Are you sure?")){getJSON({op:"deleteGame",gameID:f},function(h){document.location.reload()})}});$("#start-game").click(function(){var f=$(this).parent().parent().attr("id").substr(5);if(confirm("You are about to start game #"+f+". Are you sure?")){getJSON({op:"startGame",gameID:f},function(h){getGames()})}})}else{var c="No active games. ";c+='<button id="create-game">Create New Game</button>';$("#activeGames").html("<p>"+c+"</p>");$("#create-game").click(function(){$("#create-game-form-dialog").dialog({height:250,width:400,modal:true,buttons:{"Create Game":function(){var f=$("#create-game-form").serialize()+"&op=createGame";getJSON(f,function(h){document.location.reload()})},Cancel:function(){$(this).dialog("destroy")}}})})}})}}function updateStats(){var a={S:"spades",H:"hearts",D:"diamonds",C:"clubs",N:""};$("#round span").text(g.status.game.currentRoundID+"/"+g.status.game.rounds);var j="-";var m="N";if(g.status.round!=null){if(g.status.round.bids>g.status.round.hands){var e="+"+(g.status.round.bids-g.status.round.hands);j=g.status.round.bids+"/"+g.status.round.hands+' <font color="green">('+e+")</font>"}else{if(g.status.round.bids<g.status.round.hands){var e="-"+(g.status.round.hands-g.status.round.bids);j=g.status.round.bids+"/"+g.status.round.hands+' <font color="red">('+e+")</font>"}else{var e=0;j=g.status.round.bids+"/"+g.status.round.hands}}m=g.status.round.trump}$("#bids span").html(j);$("#trump span").removeClass().addClass(a[m]);var l=g.game.players[0];var f="";for(var h=0;h<g.game.players.length;h++){var b=g.game.players[h];var k=(g.game.currentPlayerIndex==h)?" current":"";f+='<div class="row'+k+'">';f+='<div class="player-'+g.status.player[h+1].userID+'"></div>';f+="<span>"+b.name;if(g.game.dealerIndex==h){f+=" - DEALER"}f+="<br />";if(g.status.player[h+1].score!=b.score){b.score=g.status.player[h+1].score}f+="Score: "+b.score;f+="<br />";var d=(b.bidValue<0)?"-":(b.tricks.length+" / "+b.bidValue);f+="Tricks: "+d+"</span></div>";if(b.score>l.score){l=b}}$("#leader span").text(l.name+" ("+l.score+")");$("#scoreboard").html(f)}function loadGameBoard(){g.game=new OhHeck();for(var a in g.game.renderers){g.game.setEventRenderer(a,function(h){h.callback()})}g.game.setEventRenderer("dealcard",webRenderer.dealCard);g.game.setEventRenderer("play",webRenderer.play);g.game.setEventRenderer("sorthand",webRenderer.sortHand);$("#deal").click(function(h){$(this).hide();g.game.message("Dealing...");getJSON({op:"dealHand",gameID:user.currentGameID},function(i){g.waiting=false;getRound()})});g.game.setEventRenderer("start",function(h){$(".card").click(function(){g.human.useCard(this.card)});$(".bubble").fadeOut();h.callback()});g.game.setEventRenderer("taketrick",webRenderer.takeTrick);g.game.setEventRenderer("bid",webRenderer.bid);var l=["horizontal-trick","vertical-trick"];var f=new Image();for(var e=0;e<l.length;e++){f.src="images/"+l[e]+".png"}var q=games[user.currentGameID];g.userOrder=q.users.split(",");for(var d=0;d<g.userOrder.length;d++){if(userID==g.userOrder[d]){g.userPosition=d+1;break}}doLog("Total players: "+games[user.currentGameID].numPlayers);doLog("My position: "+g.userPosition);$("#play-page").addClass("players-"+games[user.currentGameID].numPlayers);var c=[],b=null,k="",n="",m=null;for(var e=0;e<q.players;e++){k+='<div id="player-position-'+(e+1)+'" class="avatar"><div class="userPic"></div><small></small></div>';n+='<div id="player-position-'+(e+1)+'-bubble" class="bubble"><p></p></div>'}$("#playersBlock").html(k);$("#playersBidBlock").html(n);switch(games[user.currentGameID].numPlayers){case 2:m=g.userOrder[(g.userPosition+0)%q.players];$("#player-position-1 div").addClass("player-"+m);$("#player-position-1 small").text(users[m].name);b=new ComputerPlayer(users[m].name);b.top=oh.VERTICAL_MARGIN;b.left=oh.TABLE_SIZE.width/2;b.align="h";b.position="top";b.id="player-position-1";c.push(b);m=g.userOrder[(g.userPosition+1)%q.players];$("#player-position-2 div").addClass("player-"+m);$("#player-position-2 small").text(users[m].name);g.human=new HumanPlayer(users[m].name);g.human.top=oh.TABLE_SIZE.height-oh.CARD_SIZE.height-oh.VERTICAL_MARGIN;g.human.left=oh.TABLE_SIZE.width/2;g.human.align="h";g.human.position="bottom";g.human.id="player-position-2";c.push(g.human);break;case 3:m=g.userOrder[(g.userPosition+0)%q.players];$("#player-position-1 div").addClass("player-"+m);$("#player-position-1 small").text(users[m].name);b=new ComputerPlayer(users[m].name);b.top=oh.TABLE_SIZE.height/2;b.left=oh.HORIZONTAL_MARGIN;b.align="v";b.position="left";b.id="player-position-1";c.push(b);m=g.userOrder[(g.userPosition+1)%q.players];$("#player-position-2 div").addClass("player-"+m);$("#player-position-2 small").text(users[m].name);b=new ComputerPlayer(users[m].name);b.top=oh.TABLE_SIZE.height/2;b.left=oh.TABLE_SIZE.width-oh.CARD_SIZE.height-oh.HORIZONTAL_MARGIN;b.align="v";b.position="right";b.id="player-position-2";c.push(b);m=g.userOrder[(g.userPosition+2)%q.players];$("#player-position-3 div").addClass("player-"+m);$("#player-position-3 small").text(users[m].name);g.human=new HumanPlayer(users[m].name);g.human.top=oh.TABLE_SIZE.height-oh.CARD_SIZE.height-oh.VERTICAL_MARGIN;g.human.left=oh.TABLE_SIZE.width/2;g.human.align="h";g.human.position="bottom";g.human.id="player-position-3";c.push(g.human);break;case 4:default:m=g.userOrder[(g.userPosition+0)%q.players];$("#player-position-1 div").addClass("player-"+m);$("#player-position-1 small").text(users[m].name);b=new ComputerPlayer(users[m].name);b.top=oh.TABLE_SIZE.height/2;b.left=oh.HORIZONTAL_MARGIN;b.align="v";b.position="left";b.id="player-position-1";c.push(b);m=g.userOrder[(g.userPosition+1)%q.players];$("#player-position-2 div").addClass("player-"+m);$("#player-position-2 small").text(users[m].name);b=new ComputerPlayer(users[m].name);b.top=oh.VERTICAL_MARGIN;b.left=oh.TABLE_SIZE.width/2;b.align="h";b.position="top";b.id="player-position-2";c.push(b);m=g.userOrder[(g.userPosition+2)%q.players];$("#player-position-3 div").addClass("player-"+m);$("#player-position-3 small").text(users[m].name);b=new ComputerPlayer(users[m].name);b.top=oh.TABLE_SIZE.height/2;b.left=oh.TABLE_SIZE.width-oh.CARD_SIZE.height-oh.HORIZONTAL_MARGIN;b.align="v";b.position="right";b.id="player-position-3";c.push(b);m=g.userOrder[(g.userPosition+3)%q.players];$("#player-position-4 div").addClass("player-"+m);$("#player-position-4 small").text(users[m].name);g.human=new HumanPlayer(users[m].name);g.human.top=oh.TABLE_SIZE.height-oh.CARD_SIZE.height-oh.VERTICAL_MARGIN;g.human.left=oh.TABLE_SIZE.width/2;g.human.align="h";g.human.position="bottom";g.human.id="player-position-4";c.push(g.human)}for(var e=0;e<games[user.currentGameID].numPlayers;e++){var o=(c.length+e-g.userPosition)%c.length;g.game.addPlayer(c[o])}g.game.rounds=g.status.game.rounds;if(g.status.currentRoundID>0){if(g.status.round!=null){g.game.cardCount=parseInt(g.status.round.hands,10);g.game.round=g.status.currentRoundID;g.game.dealerIndex=(g.status.currentRoundID-2+g.game.players.length)%g.game.players.length;g.game.nextPlayerToDealTo=g.game.nextIndex(g.game.dealerIndex);g.game.currentPlayerIndex=g.game.nextIndex(g.game.dealerIndex);g.game.bidPlayerIndex=g.game.currentPlayerIndex;if(g.status.player[1].hand!=null&&g.status.player[1].hand){g.game.newDeck();g.game.deal()}}else{g.game.round=g.status.currentRoundID;g.game.dealerIndex=(g.status.currentRoundID-1)%g.game.players.length;g.game.nextPlayerToDealTo=g.game.nextIndex(g.game.dealerIndex);g.game.currentPlayerIndex=g.game.nextIndex(g.game.dealerIndex);g.game.bidPlayerIndex=g.game.currentPlayerIndex}}else{g.game.dealerIndex=g.game.players.length-1;g.game.nextPlayerToDealTo=g.game.nextIndex(g.game.dealerIndex);g.game.currentPlayerIndex=g.game.nextIndex(g.game.dealerIndex);g.game.bidPlayerIndex=g.game.currentPlayerIndex}}function leaveGameConfirm(a){if(confirm("You are about to leave game #"+a+". Are you sure?")){getJSON({op:"leaveGame",gameID:a},function(b){document.location.reload()})}}function doLog(a){console.log(a);$("#console").prepend("<p>"+a+"</p>")}function getJSON(b,a){$.ajax({type:"POST",url:"/api/",data:b,success:function(c){a(c)},error:function(e,d,c){doLog("Error with AJAX request: "+c.url)},dataType:"json"})};