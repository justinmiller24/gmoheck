var g={timeout:{user:null,users:null,game:null,games:null},status:{},currentRoundID:0,inLobby:true,game:null,cardsDealt:false,player:{human:null,left:null,right:null,top:null,},roundLoading:0,waiting:false,userOrder:[],userPosition:0};$(document).ready(function(){$("#reset a").click(function(){g.waiting=false;g.roundLoading=0;doLog("Reset counter to "+g.roundLoading);return false});setActiveUser();g.timeout.user=setInterval("setActiveUser();",60000);getUsers();g.timeout.users=setInterval("getUsers();",5000);getGames();g.timeout.games=setInterval("getGames();",5000)});function setActiveUser(){if(g.inLobby){getJSON({op:"setActiveUser"},function(a){})}}function getUsers(){if(g.inLobby){getJSON({op:"getUsers"},function(d){users=d.users;if(users!={}&&users!=[]){var c="";for(var b in users){var a=users[b];if(a.isActive){c+='<div class="row">';c+='<div class="player-'+b+'"></div>';c+="<span>"+a.name+"<br />";c+="Games: "+a.games+"<br />";c+="Wins: "+a.wins+"</span></div>"}}$("#playersOnline").html(c)}})}}function getGames(){if(g.inLobby){getJSON({op:"getGames"},function(f){if(f.has_data&&f.numGames>0){games=f.games;var e="";e+="<table>";e+="<thead>";e+="<tr>";e+="<th>Game</th>";e+="<th>Seats</th>";e+="<th>Players</th>";e+="<th>Status</th>";e+="</tr>";e+="</thead>";e+="<tbody>";for(var d in games){var k=games[d];if(user.currentGameID==k.id){g.userOrder=k.users.split(",");for(var b=0;b<g.userOrder.length;b++){if(userID==g.userOrder[b]){g.userPosition=b+1;break}}doLog("My position is "+g.userPosition+" / "+k.players);for(var b=0;b<k.players;b++){var l=(g.userPosition+b)%k.players;if(g.userOrder[l]){var c=g.userOrder[l];$("#player-position-"+(b+1)+" div").addClass("player-"+c);$("#player-position-"+(b+1)+" small").text(users[c].name)}}if(k.status=="Play"){doLog("switchToGame()");switchToGame()}}e+='<tr id="game-'+k.id+'" class="game">';e+="<td>GAME #"+k.id+"</td>";e+="<td>"+k.players+"</td>";e+='<td class="gamesRow">';var a=k.users.split(",");for(var d=0;d<a.length;d++){e+='<span class="player-'+a[d]+'"></span>'}e+="</td>";if(k.status=="Wait"){if(k.ownerID==userID){getJSON({op:"setActiveGame",gameID:user.currentGameID},function(){});if(k.numPlayers==k.players){e+='<td><button id="start-game">Start game</button></td>'}else{e+='<td><button id="delete-game">Delete game</button></td>'}}else{if(k.numPlayers<k.players){if(k.id!=user.currentGameID){e+='<td><button id="join-game">Join game</button></td>'}else{e+='<td><button id="leave-game">Leave game</button></td>'}}else{if(k.id!=user.currentGameID){e+="<td>Game Full</td>"}else{e+="<td>Waiting</td>"}}}}else{if(k.status=="Play"){e+="<td>In Progress</td>"}}e+="</tr>"}e+="</tbody>";e+="</table>";$("#activeGames").html(e);$("#join-game").click(function(){var h=$(this).parent().parent().attr("id").substr(5);if(confirm("You are about to join game #"+h+". Are you sure?")){getJSON({op:"joinGame",gameID:h},function(i){document.location.reload()})}});$("#leave-game").click(function(){var h=$(this).parent().parent().attr("id").substr(5);if(confirm("You are about to leave game #"+h+". Are you sure?")){getJSON({op:"leaveGame",gameID:h},function(i){document.location.reload()})}});$("#delete-game").click(function(){var h=$(this).parent().parent().attr("id").substr(5);if(confirm("This will erase all game data. Are you sure?")){getJSON({op:"deleteGame",gameID:h},function(i){document.location.reload()})}});$("#start-game").click(function(){var h=$(this).parent().parent().attr("id").substr(5);if(confirm("You are about to start game #"+h+". Are you sure?")){getJSON({op:"startGame",gameID:h},function(i){getGames()})}})}else{var e="No active games. ";e+='<button id="create-game">Create New Game</button>';$("#activeGames").html("<p>"+e+"</p>");$("#create-game").click(function(){$("#create-game-form-dialog").dialog({height:250,width:400,modal:true,buttons:{"Create Game":function(){var h=$("#create-game-form").serialize()+"&op=createGame";getJSON(h,function(i){document.location.reload()})},Cancel:function(){$(this).dialog("destroy")}}})})}})}}function switchToGame(){g.inLobby=false;clearInterval(g.timeout.user);clearInterval(g.timeout.users);clearInterval(g.timeout.games);$("#lobby-page, .lobby").hide();$("#nav").addClass("play");$("#play-page, #nav ul, .play").fadeIn();getJSON({op:"getRound",gameID:user.currentGameID},function(a){g.status=a;loadGameBoard();updateStats();updateScoreboard();g.timeout.game=setInterval("getRound();",2000);if(g.game.cardsDealt){g.waiting=true;setTimeout("g.waiting = false;",5000)}else{getRound()}})}function updateStats(){var b={S:"spades",H:"hearts",D:"diamonds",C:"clubs",N:""};$("#round span").text(g.status.game.currentRoundID+"/"+g.status.game.rounds);var e="-";var a="N";if(g.status.round!=null){if(g.status.round.bids-g.status.round.hands>0){var d="+"+(g.status.round.bids-g.status.round.hands);var c="green"}else{var d="-"+(g.status.round.hands-g.status.round.bids);var c="red"}e=g.status.round.bids+"/"+g.status.round.hands+' <font color="'+c+'">('+d+")</font>";a=g.status.round.trump}$("#bid span").html(e);$("#trump span").removeClass().addClass(b[a])}function updateScoreboard(){var e=g.game.players[0];var d="";for(var b=0;b<g.game.players.length;b++){var f=g.game.players[b];var h=(g.game.currentPlayerIndex==b)?" current":"";d+='<div class="row'+h+'">';d+='<div class="player-'+g.status.player[b+1].userID+'"></div>';d+="<span>"+f.name;if(g.game.dealerIndex==b){d+=" - DEALER"}d+="<br />";if(g.status.player[b+1].score!=f.score){f.score=g.status.player[b+1].score}d+="Score: "+f.score;d+="<br />";var a=(f.bidValue<0)?"-":(f.tricks.length+" / "+f.bidValue);d+="Tricks: "+a+"</span></div>";if(f.score>e.score){e=f}}$("#leader span").text(e.name+" ("+e.score+")");$("#scoreboard").html(d)}function loadGameBoard(){g.game=new OhHeck();for(var b in g.game.renderers){g.game.setEventRenderer(b,function(f){f.callback()})}g.game.setEventRenderer("dealcard",webRenderer.dealCard);g.game.setEventRenderer("play",webRenderer.play);g.game.setEventRenderer("sorthand",webRenderer.sortHand);$("#deal").click(function(f){$(this).hide();g.game.message("Dealing...");getJSON({op:"dealHand",gameID:user.currentGameID},function(e){g.waiting=false;getRound();doLog("TODO... update indexes")})});g.game.setEventRenderer("start",function(f){$(".card").click(function(){g.player.human.useCard(this.card)});$(".bubble").fadeOut();f.callback()});g.game.setEventRenderer("taketrick",webRenderer.takeTrick);g.game.setEventRenderer("bid",webRenderer.bid);var d=["horizontal-trick","vertical-trick"];var a=new Image();for(var c=0;c<d.length;c++){a.src="images/"+d[c]+".png"}g.player.human=new HumanPlayer($("#player-position-4 small").text());g.player.human.top=oh.TABLE_SIZE.height-oh.CARD_SIZE.height-oh.VERTICAL_MARGIN;g.player.human.left=oh.TABLE_SIZE.width/2;g.player.human.align="h";g.player.human.position="bottom";g.player.human.showCards=true;g.player.human.id="player-position-4";g.player.left=new ComputerPlayer($("#player-position-1 small").text());g.player.left.top=oh.TABLE_SIZE.height/2;g.player.left.left=oh.HORIZONTAL_MARGIN;g.player.left.align="v";g.player.left.position="left";g.player.left.showCards=false;g.player.left.id="player-position-1";g.player.top=new ComputerPlayer($("#player-position-2 small").text());g.player.top.top=oh.VERTICAL_MARGIN;g.player.top.left=oh.TABLE_SIZE.width/2;g.player.top.align="h";g.player.top.position="top";g.player.top.showCards=false;g.player.top.id="player-position-2";g.player.right=new ComputerPlayer($("#player-position-3 small").text());g.player.right.top=oh.TABLE_SIZE.height/2;g.player.right.left=oh.TABLE_SIZE.width-oh.CARD_SIZE.height-oh.HORIZONTAL_MARGIN;g.player.right.align="v";g.player.right.position="right";g.player.right.showCards=false;g.player.right.id="player-position-3";if(g.userPosition==1){g.game.addPlayer(g.player.human);g.game.addPlayer(g.player.left);g.game.addPlayer(g.player.top);g.game.addPlayer(g.player.right)}else{if(g.userPosition==2){g.game.addPlayer(g.player.right);g.game.addPlayer(g.player.human);g.game.addPlayer(g.player.left);g.game.addPlayer(g.player.top)}else{if(g.userPosition==3){g.game.addPlayer(g.player.top);g.game.addPlayer(g.player.right);g.game.addPlayer(g.player.human);g.game.addPlayer(g.player.left)}else{if(g.userPosition==4){g.game.addPlayer(g.player.left);g.game.addPlayer(g.player.top);g.game.addPlayer(g.player.right);g.game.addPlayer(g.player.human)}}}}g.game.rounds=g.status.game.rounds;doLog("# rounds in game: "+g.game.rounds);if(g.status.currentRoundID>0){if(g.status.round!=null){g.game.cardCount=parseInt(g.status.round.hands,10);doLog("Set card count: "+g.game.cardCount);g.game.round=g.status.currentRoundID;doLog("Set Round: "+g.game.round);g.game.dealerIndex=(g.status.currentRoundID-2+g.game.players.length)%g.game.players.length;g.game.nextPlayerToDealTo=g.game.nextIndex(g.game.dealerIndex);g.game.currentPlayerIndex=g.game.nextIndex(g.game.dealerIndex);g.game.bidPlayerIndex=g.game.currentPlayerIndex;doLog("Dealer: "+g.game.dealerIndex);doLog("Player: "+g.game.currentPlayerIndex);if(g.status.player[1].hand!=null&&g.status.player[1].hand){doLog("Cards already dealt... deal!");g.game.newDeck();g.game.deal()}}else{g.game.round=g.status.currentRoundID;doLog("Set Round: "+g.game.round);g.game.dealerIndex=(g.status.currentRoundID-1)%g.game.players.length;g.game.nextPlayerToDealTo=g.game.nextIndex(g.game.dealerIndex);g.game.currentPlayerIndex=g.game.nextIndex(g.game.dealerIndex);g.game.bidPlayerIndex=g.game.currentPlayerIndex;doLog("Dealer: "+g.game.dealerIndex);doLog("Player: "+g.game.currentPlayerIndex)}}else{doLog("No rounds exist yet!");g.game.dealerIndex=g.game.players.length-1;g.game.nextPlayerToDealTo=g.game.nextIndex(g.game.dealerIndex);g.game.currentPlayerIndex=g.game.nextIndex(g.game.dealerIndex);g.game.bidPlayerIndex=g.game.currentPlayerIndex;doLog("Dealer: "+g.game.dealerIndex);doLog("Player: "+g.game.currentPlayerIndex)}doLog("Seat: "+(g.status.seat-1))}function doLog(a){console.log(a);$("#console").prepend("<p>"+a+"</p>")}function getJSON(b,a){$.ajax({type:"POST",url:"/api/",data:b,success:function(c){a(c)},error:function(e,d,c){doLog("Error with AJAX request: "+c.url)},dataType:"json"})};

var oh={TABLE_SIZE:{width:700,height:600},ANIMATION_SPEED:500,CARD_PADDING:18,CARD_SIZE:{width:71,height:96},CARDBACK:{x:0,y:-4*96},CONDENSE_COUNT:6,DECK_POS:{left:700/2-1.3*71,top:600/2-96/2},HCARDBACK:{x:-8*96,y:-5*96},HORIZONTAL_MARGIN:60,OVERLAY_MARGIN:2,PILE_POS:{left:(700/2-1.3*71)+1.3*71,top:600/2-96/2},TAKE_TRICK_DELAY:750,VERTICAL_MARGIN:80,zIndexCounter:1};function $A(a){return{arr:a,each:function(c){for(var b=0;b<this.arr.length;b++){c.call(this.arr,this.arr[b])}},any:function(c){for(var b=0;b<this.arr.length;b++){if(c.call(this.arr,this.arr[b])){return true}}return false},all:function(c){for(var b=0;b<this.arr.length;b++){if(!c.call(this.arr,this.arr[b])){return false}}return true},remove:function(c){for(var b=0;b<this.arr.length;b++){if(this.arr[b]==c){this.arr.splice(b,1);return true}}return false},last:function(){if(!this.arr.length){return null}return this.arr[this.arr.length-1]}}}function Card(a,b){this.init(a,b)}Card.prototype={init:function(c,d){this.suit=c;this.rank=parseInt(d,10);var b={D:"diamonds",C:"clubs",H:"hearts",S:"spades"};var a={11:"jack",12:"queen",13:"king",14:"ace"};if(a[d]){this.longName=a[d]+" of "+b[c]}else{this.longName=d+" of "+b[c]}this.shortName=this.suit+this.rank},hideCard:function(a){if(!a){a="bottom"}var c=$(this.guiCard).height(),b=$(this.guiCard).width();if(a=="top"||a=="bottom"){$(this.guiCard).setBackground(oh.CARDBACK.x+"px",oh.CARDBACK.y+"px");if(b>c){$(this.guiCard).height(b).width(c)}}else{$(this.guiCard).setBackground(oh.HCARDBACK.x+"px",oh.HCARDBACK.y+"px");if(c>b){$(this.guiCard).height(b).width(c)}}this.rotate(0)},moveToFront:function(){this.guiCard.style.zIndex=oh.zIndexCounter++},rankName:function(){var a=[null,null,"a two","a three","a four","a five","a six","a seven","an eight","a nine","a ten","a jack","a queen","a king","an ace"];return a[this.rank]},rotate:function(a){$(this.guiCard).css("-webkit-transform","rotate("+a+"deg)").css("-moz-transform","rotate("+a+"deg)").css("-ms-transform","rotate("+a+"deg)").css("transform","rotate("+a+"deg)").css("-o-transform","rotate("+a+"deg)")},shortRankName:function(){var a=[null,null,"two","three","four","five","six","seven","eight","nine","ten","jack","queen","king","ace"];return a[this.rank]},showCard:function(a){var e={C:0,D:1,H:2,S:3};var c,f;if(!a){a="bottom"}var d=$(this.guiCard).height(),b=$(this.guiCard).width();if(a=="top"||a=="bottom"){c=(2-this.rank)*oh.CARD_SIZE.width;f=-e[this.suit]*oh.CARD_SIZE.height;if(a=="top"&&this.rank>10){c-=4*oh.CARD_SIZE.width}if(b>d){$(this.guiCard).height(b).width(d)}this.rotate(0)}else{f=-5*oh.CARD_SIZE.height;if(this.rank<=10){f-=(this.rank-2)*oh.CARD_SIZE.width;c=-e[this.suit]*oh.CARD_SIZE.height}else{c=-4*oh.CARD_SIZE.height-e[this.suit]*oh.CARD_SIZE.height;if(a=="left"){f-=(this.rank-7)*oh.CARD_SIZE.width}else{f-=(this.rank-11)*oh.CARD_SIZE.width}}if(d>b){$(this.guiCard).height(b).width(d)}this.rotate(0)}$(this.guiCard).setBackground(c+"px",f+"px")},suitName:function(){var a={D:"diamond",C:"club",H:"heart",S:"spade"};return a[this.suit]},};function OhHeck(){this.init()}OhHeck.prototype={makeRenderFunc:function(format){return function(e){with(e){var msg=eval(format.replace(/@(\w+(\.\w+)*)/g,"'+$1+'").replace(/(.*)/,"'$1'"));doLog(msg)}e.game.callbackQueue.push(e)}},init:function(){this.callbackQueue=[];this.renderers={};this.renderers.dealcard=this.makeRenderFunc("dealcard - @card - @player.name - hand: @player.hand");this.renderers.start=this.makeRenderFunc("start");this.renderers.play=this.makeRenderFunc("play - @player.name played @cards - hand: @player.hand");this.renderers.win=this.makeRenderFunc("win - @player.name");this.renderers.sorthand=this.makeRenderFunc("sorthand - @player.name - @player.hand");this.renderers.taketrick=this.makeRenderFunc("taketrick - @player.name takes the trick");this.renderers.bid=this.makeRenderFunc("bid - @player.name bids @bid")},addPlayer:function(a){a.game=this;a.pos=this.players.length;this.players.push(a)},afterDealing:function(){this.message("Sorting Hand...");for(var a=0;a<this.players.length;a++){var b=this.players[a];if(b.isHuman&&!b.handSorted){return this.sortHand(b,this.afterDealing)}}for(var a=0;a<this.players.length;a++){var b=this.players[a];b.tricks=[];b.bidValue=-1;webRenderer._adjustHand(b,function(){},50,false,g.game.cardCount)}},afterPlayCards:function(){if(this.pile.length<this.players.length){var k=this.players[this.currentPlayerIndex];this.currentPlayerIndex=this.nextIndex(this.currentPlayerIndex);this.playerStartTurn()}else{var f=0;var a=this.pile[0];var m=a;var n=(this.currentPlayerIndex+1)%this.players.length;for(var e=1;e<this.pile.length;e++){var c=this.pile[e];if(g.game.trump!="N"&&m.suit!=g.game.trump&&c.suit==g.game.trump){m=c;f=e}else{if(c.suit==m.suit&&c.rank>m.rank){m=c;f=e}}}var j=(n+f)%this.players.length;var d=this.players[0].hand.length==0;this.currentPlayerIndex=j;this.players[this.currentPlayerIndex].tricks.push(this.pile.slice(0));var h=this.pile;this.pile=[];g.game.message(g.game.players[j].name+" wins trick #"+g.game.hand);doLog("Waiting: "+g.waiting);if(!d){g.game.hand++;setTimeout("g.waiting=false; doLog('Reset waiting after 1500');",1500)}else{setTimeout("g.game.message('Scoreboard Update!');",1000);doLog("Just played last card in round");g.game.cardsDealt=false;for(var e=0;e<g.game.players.length;e++){var b=g.game.players[e];if(b.tricks.length==b.bidValue){b.score+=(10+b.bidValue);doLog("Player "+e+" made bid. Score: "+b.score)}else{b.score+=b.bidValue;doLog("Player "+e+" did not make bid. Score: "+b.score)}b.bidValue=-1;b.tricks=[]}doLog("Last round: "+this.round+" / "+this.rounds);if(this.round==this.rounds){setTimeout("g.game.message('Game over!');",2000)}}var l=!d?this.playerStartTurn:this.calculateScore;this.renderEvent("taketrick",l,{trick:h})}},allPlayersBid:function(){return($A(this.players).all(function(a){return a.bidValue>=0}))},bid:function(b,a){this.message(b.name+" bids "+a);b.bidValue=a;$("#"+b.id+" small").append(" ("+b.bidValue+")");$("#"+b.id+"-bubble p").text("I bid "+b.bidValue).parent().fadeIn();if(this.allPlayersBid()){this.renderEvent("start",this.playerStartTurn)}else{this.bidPlayerIndex=this.nextIndex(this.bidPlayerIndex)}},bidPlayerIndex:0,calculateScore:function(){doLog("Rotate dealer...");g.game.dealerIndex=g.game.nextIndex(g.game.dealerIndex);g.game.nextPlayerToDealTo=g.game.nextIndex(g.game.dealerIndex);g.game.currentPlayerIndex=g.game.nextIndex(g.game.dealerIndex);doLog("Next dealer: "+g.game.dealerIndex);doLog("Next first player: "+g.game.currentPlayerIndex)},canPlayCard:function(b,a){if(this.pile.length==0){return true}var c=this.pile[0].suit;return a.suit==c||!$A(b.hand).any(function(d){return d.suit==c})},cardCount:0,cardsDealt:false,currentPlayerIndex:0,deal:function(){if(!this.deck){this.message("Cannot deal... deck is empty!")}else{this.message("Dealing...");this.cardsDealt=true;if(this.dealtCardCount==this.cardCount*this.players.length){this.bidPlayerIndex=this.currentPlayerIndex;doLog("Done dealing");doLog("Bidder index: "+this.bidPlayerIndex);this.afterDealing();this.hand=1}else{var a=this.deck.pop();var b=this.players[this.nextPlayerToDealTo];b.hand.push(a);this.nextPlayerToDealTo=this.nextIndex(this.nextPlayerToDealTo);this.dealtCardCount++;this.renderEvent("dealcard",this.deal,{player:b,cardpos:b.hand.length-1,card:a})}}},dealerIndex:-1,dealtCardCount:0,deck:null,hand:0,message:function(a){$("#messageBox p").html(a)},newDeck:function(){this.deck=[];if(g.status.player[1].hand==null||g.status.player[1].hand==""){return false}this.trump=g.status.round.trump;doLog("Set trump suit: "+this.trump);var l=g.game.nextPlayerToDealTo;var h=Array();for(var e=0;e<g.status.game.players;e++){h.push(g.status.player[((e+l)%g.status.game.players)+1].hand.split(","))}for(var e=0;e<g.status.round.hands;e++){for(var d=0;d<h.length;d++){var c=h[d].shift();var n=c.substring(0,1);var f=c.substring(1);this.deck.unshift(new Card(n,f))}}var m=oh.DECK_POS.top;var b=oh.DECK_POS.left;for(var e=0;e<this.deck.length;e++){var a=this.deck[e];if((e+1)%oh.CONDENSE_COUNT==0){b-=oh.OVERLAY_MARGIN;m-=oh.OVERLAY_MARGIN}var k=$("<div>").addClass("card").css({left:b,top:m});$("#play-page").append(k[0]);a.guiCard=k[0];k[0].card=a;a.moveToFront();a.hideCard()}},nextIndex:function(a){return(a+1)%this.players.length},nextPlayerToDealTo:-1,pile:[],playCards:function(c,d){for(var b=0;b<d.length;b++){var a=d[b];if(!this.canPlayCard(c,a)){throw"Illegal card from "+c.name+", "+a}this.pile.push(a);a.selected=false;c.remove(a)}c.canPlay=false;this.renderEvent("play",this.afterPlayCards,{cards:d})},players:[],playerStartTurn:function(){this.players[this.currentPlayerIndex].canPlay=true},renderEvent:function(b,d,c){if(!c){c={}}if(!c.player){c.player=this.players[this.currentPlayerIndex]}c.name=b;c.game=this;var a=this;c.callback=function(){d.call(a)};this.renderers[b](c)},round:0,rounds:0,setEventRenderer:function(a,b){this.renderers[a]=b},showDealButton:function(){$("#deal").fadeIn()},sortHand:function(a,d,c){if(!a.hand){return}var b=function(f,e){if(a.handSorted=="ASC"){return e-f}return f-e};a.hand.sort(function(h,f){var e={D:0,C:1,H:2,S:3};switch(g.status.round.trump){case"D":e={C:0,H:1,S:2,D:3};break;case"C":e={H:0,S:1,D:2,C:3};break;case"H":e={S:0,D:1,C:2,H:3};break;case"S":default:e={D:0,C:1,H:2,S:3}}if(h.suit==f.suit){return b(h.rank,f.rank)}return b(e[h.suit],e[f.suit])});a.handSorted=(a.handSorted=="ASC")?"DESC":"ASC";if(!c){this.renderEvent("sorthand",d||function(){})}},trump:"N",};function ComputerPlayer(a){this.init(a)}ComputerPlayer.prototype={name:null,hand:null,isHuman:false,score:0,tricks:[],bidValue:-1,init:function(a){this.name=a;this.hand=[]},extend:function(b){this.base={};for(var a in b){if(this[a]){this.base[a]=this[a]}this[a]=b[a]}},hasCard:function(a){for(var b=0;b<this.hand.length;b++){if(this.hand[b]==a){return true}}return false},remove:function(a){return $A(this.hand).remove(a)},};function HumanPlayer(a){this.init(a)}HumanPlayer.prototype={name:null,hand:null,isHuman:true,score:0,tricks:[],bidValue:-1,doBid:function(a){if(this.isBidding){this.isBidding=false;getJSON({op:"makeBid",gameID:user.currentGameID,roundID:g.status.currentRoundID,bid:a},function(b){g.waiting=false;g.game.bid(g.player.human,a)})}else{this.game.message("You cannot bid until your turn.")}},startBid:function(){$("#bid-div").css("z-index",oh.zIndexCounter+10000).show();this.game.message("Choose how many tricks you think you will take.");var a=(this.game.dealerIndex==g.status.seat-1);var b=(g.status.round.hands-g.status.round.bids);$("#bid-div-inner div").remove();for(var c=0;c<=g.status.round.hands;c++){if(a&&(c==b)){$("<div/>").text(c).addClass("cannotBid").appendTo("#bid-div-inner").click(function(d){g.game.message("Nice try! You cannot bid "+$(this).text()+"!")}).mouseover(function(){g.game.message("Anything but "+$(this).text())})}else{$("<div/>").text(c).appendTo("#bid-div > div").click(function(d){g.player.human.doBid(parseInt($(this).text()));$("#bid-div").hide();g.game.message("Loading...")}).mouseover(function(){g.game.message("Bid "+$(this).text())})}}this.isBidding=true},useCard:function(a){if(g.waiting){if(this.isBidding){this.game.message("It's your turn to bid now. You can't play any card while you're bidding!")}else{this.game.message("");if(!this.hasCard(a)){this.game.message("You cannot play that card!")}else{if(!this.canPlay){this.game.message("It's not your turn to play!")}else{if(!this.game.canPlayCard(this,a)){this.game.message("Nice try! You must follow suit by playing a "+this.game.pile[0].suitName())}else{this.game.message("Playing the "+a.longName);getJSON({op:"playCard",gameID:user.currentGameID,roundID:g.status.currentRoundID,handID:g.status.handID,card:a.shortName},function(b){if(b.has_data){g.game.playCards(g.game.players[g.game.currentPlayerIndex],[a]);g.waiting=false;setTimeout("g.waiting=false; doLog('Reset waiting after 1500');",1500)}else{g.game.message("Error: "+b.error)}})}}}}}else{this.game.message("Retry after this message updates")}},init:ComputerPlayer.prototype.init,hasCard:ComputerPlayer.prototype.hasCard,remove:ComputerPlayer.prototype.remove};jQuery.fn.moveCard=function(d,c,e,b){var a={};a.top=d;a.left=c;a.queue=false;this.animate(a,b||oh.ANIMATION_SPEED,e);return this};jQuery.fn.setBackground=function(a,c){var b={};b["background-position"]=a+" "+c;this.css(b);return this};function showCards(c,a,b){setTimeout(function(){for(var d=0;d<c.length;d++){c[d].showCard(a)}},b||(oh.ANIMATION_SPEED/2))}function hideCards(c,a,b){setTimeout(function(){for(var d=0;d<c.length;d++){c[d].hideCard(a)}},b||(oh.ANIMATION_SPEED/2))}var webRenderer={_adjustHand:function(k,l,b,a,e){if(!b){b=oh.ANIMATION_SPEED}for(var d=0;d<k.hand.length;d++){var c=k.hand[d];var j=webRenderer._getCardPos(k,d,e);var h;if(d==k.hand.length-1){h=l}$(c.guiCard).moveCard(j.top,j.left,h,b);if(!a){c.moveToFront()}}if(k.showCards){showCards(k.hand,k.position,b/2)}else{hideCards(k.hand,k.position,b/2)}},_getCardPos:function(c,f,a){if(!a){a=c.hand.length}var e=(a-1)*oh.CARD_PADDING+oh.CARD_SIZE.width;var d={};var b=0;if(c.hand[f]&&c.hand[f].selected){b=15}if(c.position=="top"){d.left=(c.left+e/2-oh.CARD_SIZE.width)-f*oh.CARD_PADDING;d.top=c.top+b}else{if(c.position=="bottom"){d.left=c.left-(e/2)+f*oh.CARD_PADDING;d.top=c.top-b}else{if(c.position=="left"){d.top=c.top-(e/2)+f*oh.CARD_PADDING;d.left=c.left+b}else{if(c.position=="right"){d.top=(c.top+e/2-oh.CARD_SIZE.width)-f*oh.CARD_PADDING;d.left=c.left-b}}}}return d},dealCard:function(a){webRenderer._adjustHand(a.player,a.callback,50,false,a.game.cardCount)},play:function(c){oh.PILE_POS.left=(oh.TABLE_SIZE.width-oh.CARD_SIZE.width)/2;oh.PILE_POS.top=(oh.TABLE_SIZE.height-oh.CARD_SIZE.height)/2;if(c.player.position=="top"){oh.PILE_POS.top-=60}else{if(c.player.position=="bottom"){oh.PILE_POS.top+=10}else{if(c.player.position=="left"){oh.PILE_POS.left-=40;oh.PILE_POS.top-=25}else{if(c.player.position=="right"){oh.PILE_POS.left+=40;oh.PILE_POS.top-=25}}}}var b=c.game.pile.length-c.cards.length;function a(e){if(c.cards.length==0){c.callback()}else{var f=c.player.hand.slice(0);$A(c.cards).each(function(i){f.push(i)});f.sort(function(k,i){return $(k.guiCard).css("z-index")-$(i.guiCard).css("z-index")});for(var e=f.length-1;e>=0;e--){$(f[e].guiCard).css("z-index",oh.zIndexCounter+e+1)}oh.zIndexCounter+=f.length+3;var d=c.cards[0];$A(c.cards).remove(c.cards[0]);var j=oh.PILE_POS.top-(Math.floor((b+e)/oh.CONDENSE_COUNT)*oh.OVERLAY_MARGIN);var h=oh.PILE_POS.left-(Math.floor((b+e)/oh.CONDENSE_COUNT)*oh.OVERLAY_MARGIN);$(d.guiCard).moveCard(j,h,function(){a(e+1)});if(c.cards.length==0){webRenderer._adjustHand(c.player,null,oh.ANIMATION_SPEED,true)}showCards([d])}}if(c.cards.length>1&&$($A(c.cards).last().guiCard).css("top")!=$(c.cards[0].guiCard).css("top")){doLog("about to animate");$($A(c.cards).last().guiCard).animate({top:$(c.cards[0].guiCard).css("top")},oh.ANIMATION_SPEED/4,function(){a(0)})}else{a(0)}},sortHand:function(a){webRenderer._adjustHand(a.player,a.callback)},takeTrick:function(a){setTimeout(function(){$A(a.trick).each(function(i){$(i.guiCard).addClass("trick")});var o={};var q;var h={};var e=2;var d=45;var n=33;var p=d/2;var j=n/2;var l=10;var f=50;var k=250;var b=e+(f-d)/2;var c=(oh.TABLE_SIZE.width/2)+f/2+a.player.tricks.length*l;if(a.player.position=="top"){o.left=((oh.TABLE_SIZE.width-oh.CARD_SIZE.width)/2)+"px";q="verticalTrick";h.top=b;h.left=c;o=h}else{if(a.player.position=="bottom"){q="verticalTrick";h.bottom=e+$("#player-position-4").height()-f+((f-d)/2);h.right=c;o.top=oh.TABLE_SIZE.height-h.bottom-oh.CARD_SIZE.height;o.left=oh.TABLE_SIZE.width-h.right-oh.CARD_SIZE.width}else{if(a.player.position=="left"){q="horizontalTrick";h.bottom=oh.TABLE_SIZE.height-k+a.player.tricks.length*l;h.left=b+1;o.top=oh.TABLE_SIZE.height-h.bottom-oh.CARD_SIZE.height;o.left=h.left}else{if(a.player.position=="right"){q="horizontalTrick";h.top=k+$("#player-position-1").height()+a.player.tricks.length*l;h.right=b;o.top=h.top;o.left=oh.TABLE_SIZE.width-h.right-oh.CARD_SIZE.width}}}}for(var m=0;m<a.trick.length;m++){a.trick[m].moveToFront()}for(var m=0;m<a.trick.length-1;m++){$(a.trick[m].guiCard).animate(o,oh.ANIMATION_SPEED,function(){})}$(a.trick[a.trick.length-1].guiCard).animate(o,oh.ANIMATION_SPEED,function(){$(".trick").hide();$("#play-page").append($("<div/>").addClass(q).css(h));a.callback()})},oh.TAKE_TRICK_DELAY)},};function getRound(){if(!g.waiting){if(g.roundLoading==0){g.roundLoading++;getJSON({op:"getRound",gameID:user.currentGameID},function(c){g.roundLoading=0;g.status=c;updateStats();updateScoreboard();if(!g.game.cardsDealt&&g.status.player[1].hand==null){if(g.game.round==g.game.rounds){g.game.message("Game over -- thanks for playing!");g.waiting=true}else{if(g.game.dealerIndex+1==g.status.seat){g.game.message("Waiting for you to deal!");$("#deal").fadeIn();g.waiting=true}else{g.game.message("Waiting for "+g.game.players[g.game.dealerIndex].name+" to deal");g.waiting=false}}}else{if(!g.game.cardsDealt){g.waiting=false;g.game.cardCount=parseInt(g.status.round.hands,10);doLog("Set card count: "+g.game.cardCount);g.game.newDeck();g.game.round++;doLog("Next player: "+g.game.currentPlayerIndex);doLog("New dealer: "+g.game.dealerIndex);doLog("New round: "+g.game.round);doLog("Cards just dealt -- shift indexes");g.game.deal()}else{g.waiting=false;while(g.game.players[g.game.bidPlayerIndex].bidValue==-1&&g.status.player[g.game.bidPlayerIndex+1].bid!=null){g.game.bid(g.game.players[g.game.bidPlayerIndex],g.status.player[g.game.bidPlayerIndex+1].bid)}if(g.status.player[g.status.seat].bid==null){if(g.status.seat==g.game.bidPlayerIndex+1){g.waiting=true;g.player.human.startBid()}else{g.waiting=false;g.game.message("Waiting for "+g.game.players[g.game.bidPlayerIndex].name+" to bid")}}else{if(g.game.players[g.game.bidPlayerIndex].bidValue==-1){g.waiting=false;g.game.message("Waiting for "+g.game.players[g.game.bidPlayerIndex].name+" to bid")}else{g.waiting=(g.status.seat==g.game.currentPlayerIndex+1);var b=getNumCards(g.status.player[g.game.currentPlayerIndex+1].currentHand);if(g.game.players[g.game.currentPlayerIndex].hand.length>b){var a=g.status.hand[g.game.hand][g.game.currentPlayerIndex+1].card;var d=g.game.players[g.game.currentPlayerIndex];for(var e=0;e<d.hand.length;e++){if(d.hand[e].shortName==a){g.game.message(g.game.players[d.pos].name+" played the "+d.hand[e].longName);g.game.playCards(d,[d.hand[e]]);if(g.userPosition==d.pos+1){g.waiting=false}e=d.hand.length}}}else{if(g.status.seat==g.game.currentPlayerIndex+1){g.game.message("Your turn! Select a card to play")}else{g.game.message("Waiting for "+g.game.players[g.game.currentPlayerIndex].name+" to play")}}}}}}})}else{g.roundLoading++;if(g.roundLoading==5){doLog("Refresh timer... wait 5 seconds");g.waiting=true;g.roundLoading=0;setTimeout("g.waiting = false;",5000)}}}}function getNumCards(a){if(a==null||a==""){return 0}var b=a.split(",");return b.length};